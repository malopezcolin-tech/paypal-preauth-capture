<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PayPal PreAuth Demo</title>
  <script src="https://www.paypal.com/sdk/js?client-id=AQipbXia4TEIQOiol5Q7ZMkpJOBM5grLZDuQOOYd6HvUG16a7pK0a_NndaRsorh9oD98QIhbYtEC1Tww&components=buttons,hosted-fields&intent=authorize&currency=USD"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
    }
    .field-container {
      margin-bottom: 1rem;
    }
    #card-container {
      border: 1px solid #ccc;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      max-width: 400px;
    }
    #card-errors {
      color: red;
      margin-top: 0.5rem;
    }
    button {
      margin-top: 1rem;
      padding: 0.7rem 1.2rem;
      border: none;
      border-radius: 5px;
      background-color: #0070ba;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>PayPal PreAuth Capture</h1>

  <label for="amount">Monto (USD):</label>
  <input type="number" id="amount" value="10.00" step="0.01" min="1">

  <h2>üí≥ Pagar con tarjeta</h2>
  <div id="card-container">
    <div class="field-container" id="card-number"></div>
    <div class="field-container" id="cvv"></div>
    <div class="field-container" id="expiration-date"></div>
    <div id="card-errors"></div>
    <button id="authorize-card" disabled>Autorizar con tarjeta</button>
  </div>

  <h2>üÖøÔ∏è Pagar con PayPal</h2>
  <div id="paypal-button-container"></div>

  <script>
    // üîπ PayPal Button (con monto din√°mico)
    paypal.Buttons({
      createOrder: function(data, actions) {
        const amount = document.getElementById("amount").value;
        return fetch("/create-order", {
          method: "post",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ amount })
        })
        .then(res => res.json())
        .then(order => order.id);
      },
      onApprove: function(data) {
        return fetch("/capture-order", {
          method: "post",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderID: data.orderID })
        })
        .then(res => res.json())
        .then(details => {
          alert("‚úÖ Pago PayPal autorizado con ID: " + details.id);
        });
      }
    }).render("#paypal-button-container");

    // üîπ Hosted Fields (tarjetas)
    if (paypal.HostedFields.isEligible()) {
      paypal.HostedFields.render({
        createOrder: () => {
          const amount = document.getElementById("amount").value;
          return fetch("/create-order", {
            method: "post",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ amount })
          })
          .then(res => res.json())
          .then(order => order.id);
        },
        styles: {
          input: { "font-size": "16px", "color": "#3A3A3A" },
          ":focus": { "color": "blue" }
        },
        fields: {
          number: { selector: "#card-number", placeholder: "N√∫mero de tarjeta" },
          cvv: { selector: "#cvv", placeholder: "CVV" },
          expirationDate: { selector: "#expiration-date", placeholder: "MM/AA" }
        }
      }).then(hostedFieldsInstance => {
        document.getElementById("authorize-card").disabled = false;

        document.getElementById("authorize-card").addEventListener("click", () => {
          hostedFieldsInstance.submit({
            contingencies: ["3D_SECURE"]
          }).then(payload => {
            return fetch("/capture-order", {
              method: "post",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ orderID: payload.orderId })
            });
          }).then(res => res.json())
            .then(details => {
              alert("‚úÖ Pago con tarjeta autorizado con ID: " + details.id);
            })
            .catch(err => {
              document.getElementById("card-errors").innerText = err.message;
            });
        });
      });
    } else {
      document.querySelector("#card-container").innerHTML = "<p>üö´ Pago con tarjeta no disponible en este navegador.</p>";
    }
  </script>
</body>
</html>
